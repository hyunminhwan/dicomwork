<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>DICOM Viewer</title>
	<script src="https://unpkg.com/cornerstone-core/dist/cornerstone.js"></script>
	<script src="https://unpkg.com/cornerstone-tools"></script>
	<script src="https://unpkg.com/dicom-parser"></script>
	<script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
</head>

<body>

	<div th:replace="~{fragments/header.html :: fragment-menu}"></div>

	<!-- DICOM 이미지를 표시할 단일 뷰어 컨테이너 -->
	<div class="viewer-container" id="dicomViewer" style="width:1200px; height:800px; border:1px solid black;">
		<!-- 이미지 경로를 저장한 데이터 -->
		<span th:each="image : ${images}" th:data-path="@{'/mhg/' + ${image.path} + ${image.fName}}"></span>
	</div>
	
</body>

<script>
	
	cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
	cornerstoneWADOImageLoader.configure({useWebWorkers: true});

	// DICOM 이미지를 단일 뷰어 컨테이너에서 로드하고 전환
	const dicomElement = document.getElementById('dicomViewer');
	const imageElements = dicomElement.querySelectorAll('[data-path]');
	const imageList = Array.from(imageElements).map(el => el.getAttribute('data-path'));

	// cornerstone 활성화
	cornerstone.enable(dicomElement);

	let currentImageIndex = 0;
	const totalImages = imageList.length;

	// 이미지 로드 함수
	function loadDicomImage(index) {
		const dicomFilePath = imageList[index]; // currentImageIndex에 따른 이미지 로드
		// cornerstone을 사용해 DICOM 이미지 로드 및 표시
		cornerstone.loadAndCacheImage('wadouri:' + dicomFilePath).then(function (image) {
			cornerstone.displayImage(dicomElement, image);
			dicomElement.classList.remove('hidden');  // 이미지가 있으면 뷰어를 표시
		}).catch(function (error) {
			console.error('Error loading DICOM image:', error);
			dicomElement.classList.add('hidden');  // 이미지가 없으면 뷰어를 숨김
		});
	}

	// 처음 이미지 로드
	if (totalImages > 0) {
		loadDicomImage(currentImageIndex); // 첫 번째 이미지를 로드
	} else {
		console.error('No DICOM images to display.');
		dicomElement.classList.add('hidden');  // 이미지가 없으면 뷰어를 숨김
	}

	// 마우스 휠 이벤트 처리 (이미지 전환)
	dicomElement.addEventListener('wheel', function (e) {
		if (e.deltaY > 0) {
			// 마우스 휠 아래로 (다음 이미지)
			currentImageIndex = (currentImageIndex + 1) % totalImages;
		} else {
			// 마우스 휠 위로 (이전 이미지)
			currentImageIndex = (currentImageIndex - 1 + totalImages) % totalImages;
		}
		loadDicomImage(currentImageIndex); // 현재 이미지 인덱스에 해당하는 이미지 로드
		e.preventDefault(); // 페이지 스크롤 방지
	});
	
</script>

</html>
